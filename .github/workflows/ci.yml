name: Code Validation

on:
  push:
    branches: [ main, develop, 'claude/**' ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate CUDA source syntax
      run: |
        echo "=== Checking CUDA source files ==="
        # Check that main source file exists and has expected structure
        test -f bip39_hybrid_optimized.cu
        echo "✓ Main CUDA source file exists"

        # Check for required functions
        grep -q "__global__ void test_combinations_kernel" bip39_hybrid_optimized.cu
        echo "✓ Main kernel function found"

        grep -q "__device__ bool validate_checksum" bip39_hybrid_optimized.cu
        echo "✓ Checksum validation function found"

        grep -q "sha256_hash" bip39_hybrid_optimized.cu
        echo "✓ SHA256 implementation found"

    - name: Validate wordlists
      run: |
        echo "=== Checking wordlist files ==="
        test -f english.txt && echo "✓ English wordlist exists"
        test -f french.txt && echo "✓ French wordlist exists"

        # Verify wordlist sizes (BIP39 requires exactly 2048 words)
        EN_COUNT=$(wc -l < english.txt)
        FR_COUNT=$(wc -l < french.txt)

        if [ "$EN_COUNT" -eq 2048 ]; then
          echo "✓ English wordlist has 2048 words"
        else
          echo "✗ English wordlist has $EN_COUNT words (expected 2048)"
          exit 1
        fi

        if [ "$FR_COUNT" -eq 2048 ]; then
          echo "✓ French wordlist has 2048 words"
        else
          echo "✗ French wordlist has $FR_COUNT words (expected 2048)"
          exit 1
        fi

    - name: Validate Unicode encoding
      run: |
        echo "=== Checking Unicode encoding ==="
        # Verify french.txt uses NFC encoding (not NFD)
        # NFD 'é' = 65 cc 81, NFC 'é' = c3 a9
        if grep -q $'\xcc\x81' french.txt; then
          echo "✗ French wordlist uses NFD encoding (will cause lookup failures)"
          exit 1
        else
          echo "✓ French wordlist uses correct NFC encoding"
        fi

    - name: Check phrases file format
      run: |
        echo "=== Checking phrases file ==="
        if [ -f phrases_14_mots.txt ]; then
          # Check first line has 14 words
          WORD_COUNT=$(head -1 phrases_14_mots.txt | wc -w)
          if [ "$WORD_COUNT" -eq 14 ]; then
            echo "✓ Phrases file has correct format (14 words per line)"
          else
            echo "✗ First phrase has $WORD_COUNT words (expected 14)"
            exit 1
          fi
          PHRASE_COUNT=$(wc -l < phrases_14_mots.txt)
          echo "✓ Phrases file contains $PHRASE_COUNT phrases"
        else
          echo "⚠ No phrases file found (phrases_14_mots.txt)"
        fi

    - name: Validate Makefile
      run: |
        echo "=== Checking Makefile ==="
        test -f Makefile && echo "✓ Makefile exists"
        grep -q "nvcc" Makefile && echo "✓ NVCC compiler configured"
        grep -q "sm_89" Makefile && echo "✓ RTX 4090 architecture target (sm_89)"

  # Optional: CUDA compilation (only if CUDA toolkit installs successfully)
  build-cuda:
    runs-on: ubuntu-latest
    continue-on-error: true  # Don't fail the whole workflow if CUDA install fails

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install CUDA Toolkit
      id: cuda-toolkit
      uses: Jimver/cuda-toolkit@v0.2.17
      continue-on-error: true
      with:
        cuda: '12.2.0'
        method: 'network'
        sub-packages: '["nvcc"]'

    - name: Compile (if CUDA available)
      if: steps.cuda-toolkit.outcome == 'success'
      run: |
        nvcc --version
        # Use generic architecture for CI (no GPU required for compilation)
        nvcc -arch=sm_50 -O3 bip39_hybrid_optimized.cu -o bip39_hybrid
        echo "✓ Compilation successful"

    - name: Skip notice
      if: steps.cuda-toolkit.outcome != 'success'
      run: |
        echo "⚠ CUDA toolkit installation failed - skipping compilation"
        echo "This is expected in some CI environments"
        echo "The code can be compiled locally with: make"
